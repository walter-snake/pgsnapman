#!/bin/bash

# pgsnap_upload: uploads status information to the central configuration database
#                     must run on a backup worker, with passwordless (.pgpass does the job) to the
#                     central configuration database
# Actions taken:
#   1 reads all files to upload from the pgsnapman root upload directory
#   2 uploads data to the corresponding table

# ======================================
# Initialization
# ======================================
VERBOSITY=$1

# Get the script directory (must do this first)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPTPATH="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# Load functions, will also perform initialization operations
. ${SCRIPTPATH}/pgsnap_lib

# ============================
# Functions
# ============================

# Generic upload function, searches for files in upload dir, name pattern: '*.<destination>.dat'
# $1 log destination [message|catalog], uploads to the catalog database table pgsnap_<destination>
function uploaddata {
  # Set SQL
  if [ "$1" == "message" ]; then
    sql="\COPY pgsnap_message (logtime, level, pgsnap_tool,  message) FROM stdin";
  elif [ "$1" == "catalog" ]; then
    sql="\COPY pgsnap_catalog (pgsnap_dumpjob_id, starttime, endtime, status, bu_name, bu_location, dbsize, dumpsize) FROM stdin"
  fi
  # Find files
  find ${ROOTDIR}/upload -name "*.${1}.dat" > ${ROOTDIR}/upload/upload.dat.list
   while read line; do
    echo -e "\.\n" | cat ${line} - | ${PGSCBIN}/psql ${PGSCHOST} -p ${PGSCPORT} -U ${PGSCUSER} --dbname=${PGSCDB} -c "${sql}" 2> ${ROOTDIR}/upload/pgsnap_upload.psql.log
    if [ "$?" == "0" ]; then
      echo "INFO `date '+%Y%m%dT%H%M%S'` pgsnap_upload processing - finished uploading ${1} data: ${line}" >> ${PGSNAPMANLOG}
      rm -f ${line}
    else
      # Inspect log, read first line (makes a difference: without connection, we leave the upload in place, an invalid data file must be removed)
      if [ "`grep -E '^psql' ${ROOTDIR}/upload/pgsnap_upload.psql.log`" == "" ]; then 
        echo "ERROR `date '+%Y%m%dT%H%M%S'` pgsnap_upload processing - failed uploading ${1} data (SQL/data error): ${line}" >> ${PGSNAPMANLOG}
        # remove illegal file
        rm -f ${line}
      else
        echo "ERROR `date '+%Y%m%dT%H%M%S'` pgsnap_upload processing - failed uploading ${1} data (connection error): ${line}" >> ${PGSNAPMANLOG}
      fi
    fi
  done < ${ROOTDIR}/upload/upload.dat.list
  rm -f ${ROOTDIR}/upload/upload.dat.list
  rm -f ${ROOTDIR}/upload/pgsnap_upload.psql.log
}


# ================================================================================
# MAIN
# ===============================================================================
# Tool log
TOOL_LOG=${ROOTDIR}/pgsnap_cacheconfig.log 

# Set the worker id for this worker instance
BUWORKERID=$(getworkerid "EXIT_ON_ERROR")

# Display information
if [ "$VERBOSITY" == "VERBOSE" ]; then
  echo ""
  echo "+--------------------+"
  echo "| pgsnap_upload      |"
  echo "+--------------------+"
  echo ""
  echo "Config file:           ${CONFIGFILE}"
  echo ""
  echo "PgSnapman worker fqdn: ${FQDN}"
  echo "PgSnapman worker id:   ${BUWORKERID}"
  echo ""
  echo "Global pgsnapman catalog db"
  echo "  db:   ${PGSCDB}"
  echo "  host: ${PGSCHOST}"
  echo "  port: ${PGSCPORT}"
  echo "  user: ${PGSCUSER}"
  echo ""
fi

# Upload the data for the available categories
uploaddata message
uploaddata catalog

exit 0

